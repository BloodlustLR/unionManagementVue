<template>
<div class="reportPayment">
    <div class="header">
        <div class="title">
            {{paymentInfo.name}}
        </div>
        <div class="header-right">
            <el-dropdown trigger="click">
                <svg class="icon" width="30" height="30" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-365b8594="" style="margin-top:15px;margin-right:10px"><path fill="white" d="M176 416a112 112 0 100 224 112 112 0 000-224m0 64a48 48 0 110 96 48 48 0 010-96zm336-64a112 112 0 110 224 112 112 0 010-224zm0 64a48 48 0 100 96 48 48 0 000-96zm336-64a112 112 0 110 224 112 112 0 010-224zm0 64a48 48 0 100 96 48 48 0 000-96z"></path></svg>
                <template #dropdown>
                <el-dropdown-menu>
                    <el-dropdown-item @click="detailModal=true">补损详情</el-dropdown-item>
                    <el-dropdown-item @click="applyArmyModal=true">批量修改军团</el-dropdown-item>
                    <el-dropdown-item @click="submit">提交</el-dropdown-item>
                </el-dropdown-menu>
                </template>
            </el-dropdown>
        </div>
    </div>

    <div class="list">
        <div v-for="(detectResult,index) in detectResultList" :key="index" class="list-item">
            <el-card class="box-card" style="height:220px;width:90%;margin:10px auto;text-align:left">
                <div class="report-item">时间: {{detectResult.reportTime}}</div>
                <div class="report-item">军团缩写: {{detectResult.armyShortName}}</div>
                <div class="report-item">角色名: {{detectResult.gameId}}</div>
                <div class="report-item">舰船名: {{detectResult.shipName}}</div>
                <div class="report-item">星域: {{detectResult.area}}</div>
                <div class="report-item">星座: {{detectResult.constellation}}</div>
                <div class="report-item">星系: {{detectResult.galaxy}}</div>
                <div class="report-item">金额: {{thousandBitSeparator(detectResult.money)}}</div>
                <div class="report-item">最后一击: {{detectResult.kmShip}}</div>
                <div class="report-item">最高伤害: {{detectResult.highATKShip}}</div>

                <div class="box-remove" @click="removeResult(index)">X</div>
                <div class="box-info">
                    <div v-if="detectResult.info">{{detectResult.info}}</div>
                    <div style="margin-top:10px">
                        <el-button type="warning" size="mini" @click="openModifyModal(detectResult,index)">修改</el-button>
                        <el-button type="primary" size="mini" @click="openImgModal(detectResult.img)">查看截图</el-button>
                    </div>
                </div>
            </el-card>
        </div>
        <div v-for="(item,key,index) in loadingList" :key="index" class="list-item">
            <el-card class="box-card" style="height:220px;width:90%;margin:10px auto;text-align:left">
                <el-progress type="circle" :percentage="item" style="vertical-align:middle;margin-right:10%"/>
                <span>文件【{{key}}】解析中</span>
            </el-card>
        </div>
        <div style="margin-top:10px;">
            <el-upload v-if="!hasOutOfDate" accept="image/jpeg,image/png" :action="uploadUrl" :on-success="handleSuccess" :before-upload="beforeUpload" :show-file-list="false" :on-progress="uploadProgress" drag multiple>
                <svg class="icon" width="200" height="140" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-365b8594=""><path fill="#1E90FF" d="M544 864V672h128L512 480 352 672h128v192H320v-1.6c-5.376.32-10.496 1.6-16 1.6A240 240 0 0164 624c0-123.136 93.12-223.488 212.608-237.248A239.808 239.808 0 01512 192a239.872 239.872 0 01235.456 194.752c119.488 13.76 212.48 114.112 212.48 237.248a240 240 0 01-240 240c-5.376 0-10.56-1.28-16-1.6v1.6H544z"></path></svg>
                <div class="el-upload__text">
                    拖拽文件到这里或者<em>点击上传</em>
                </div>
                <template #tip>
                <div class="el-upload__tip">
                    只支持jpg/png文件
                </div>
                </template>
            </el-upload>
            <span v-if="hasOutOfDate">此次补损已截止</span>
        </div>
        <div style="height:50px;width:100%;"></div>
        <div class="sumbit-button" @click="submit">
            提交
        </div>
    </div>

    <el-dialog v-model="detailModal" title="补损详情" width="80%">
        <div class="payment-box">
            <div class="payment-item">补损编号-{{paymentInfo.id}}</div>
            <div class="payment-item">补损名-{{paymentInfo.name}}</div>
            <div class="payment-item">允许时间段-{{paymentInfo.lossStartTime}}<span v-show="paymentInfo.lossStartTime!=null&&paymentInfo.lossEndTime!=null">至</span>{{paymentInfo.lossEndTime}}</div>
            <div class="payment-item">允许星域-{{paymentInfo.limitArea==null?'无限制':paymentInfo.limitArea}}</div>
            <div class="payment-item">允许星座-{{paymentInfo.limitConstellation==null?'无限制':paymentInfo.limitConstellation}}</div>
            <div class="payment-item">允许星系-{{paymentInfo.limitGalaxy==null?'无限制':paymentInfo.limitGalaxy}}</div>
            <div class="payment-item">截止时间-{{paymentInfo.endTime}}</div>
        </div>
        <template #footer>
        <span class="dialog-footer">
            <el-button @click="detailModal = false">关闭</el-button>
        </span>
        </template>
    </el-dialog>

    <el-dialog v-model="modifyModal" title="补损详情" width="80%">
        <div class="modify-box">
            <div class="modify-item">
                <span style="margin-right:10px">时间</span>
                <el-date-picker v-model="lossInfo.reportTime" type="datetime" placeholder="请选择损失时间" disabled></el-date-picker>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">军团简称</span>
                <el-select v-model="lossInfo.armyShortName" placeholder="请选择军团简称" style="width:220px" filterable>
                    <el-option v-for="item in armyList" :key="item.shortName" :label="item.shortName" :value="item.shortName"></el-option>
                </el-select>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">角色名</span>
                <el-input v-model="lossInfo.gameId" placeholder="请输入角色名" style="width:220px"/>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">舰船名</span>
                <el-select v-model="lossInfo.shipName" placeholder="请选择舰船名" style="width:220px" filterable>
                    <el-option v-for="item in shipList" :key="item.name" :label="item.name" :value="item.name"></el-option>
                </el-select>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">星域</span>
                <!-- <el-input v-model="lossInfo.area" placeholder="请输入星域" style="width:220px" disabled/> -->
                <el-select v-model="lossInfo.area" filterable allow-create default-first-option placeholder="请输入星域" style="width:220px" disabled>
                    <template v-if="paymentInfo.limitArea!=null">
                        <el-option v-for="item in paymentInfo.limitArea" :key="item" :label="item" :value="item"></el-option>
                    </template>
                </el-select>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">星座</span>
                <!-- <el-input v-model="lossInfo.constellation" placeholder="请输入星座" style="width:220px"/> -->
                <el-select v-model="lossInfo.constellation" filterable allow-create default-first-option placeholder="请输入星座" style="width:220px">
                    <template v-if="paymentInfo.limitConstellation!=null">
                        <el-option v-for="item in paymentInfo.limitConstellation" :key="item" :label="item" :value="item"></el-option>
                    </template>
                </el-select>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">星系</span>
                <!-- <el-input v-model="lossInfo.galaxy" placeholder="请输入星系" style="width:220px"/> -->
                <el-select v-model="lossInfo.galaxy" filterable allow-create default-first-option placeholder="请输入星系" style="width:220px">
                    <template v-if="paymentInfo.limitGalaxy!=null">
                        <el-option v-for="item in paymentInfo.limitGalaxy" :key="item" :label="item" :value="item"></el-option>
                    </template>
                </el-select>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">金额</span>
                <el-input-number v-model="lossInfo.money" :min="0" :step="1" :precision="0" step-strictly style="width:220px" :disabled="lossInfo.money!=''&&lossInfo.money!=null"/>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">最后一击</span>
                <el-input v-model="lossInfo.kmShip" placeholder="请输入最后一击舰船名" style="width:220px"/>
            </div>
            <div class="modify-item">
                <span style="margin-right:10px">最高伤害</span>
                <el-input v-model="lossInfo.highATKShip" placeholder="请输入最高伤害舰船名" style="width:220px"/>
            </div>
        </div>
        <template #footer>
        <span class="dialog-footer">
            <el-button type="primary" @click="modifyData">确认</el-button>
            <el-button @click="modifyModal = false">关闭</el-button>
        </span>
        </template>
    </el-dialog>

    <el-dialog v-model="imgModal" title="截图" width="80%">
        <img :src="imgSrc" style="width:100%;height:100%;"/>
        <template #footer>
        <span class="dialog-footer">
            <el-button @click="imgModal = false">关闭</el-button>
        </span>
        </template>
    </el-dialog>

    <el-dialog v-model="applyArmyModal" title="批量修改军团" width="80%">
        <el-select v-model="applyArmyShortName" placeholder="请选择军团简称" style="width:220px" filterable>
            <el-option v-for="item in armyList" :key="item.shortName" :label="item.shortName" :value="item.shortName"></el-option>
        </el-select>
        <template #footer>
        <span class="dialog-footer">
            <el-button @click="applyArmy">修改</el-button>
            <el-button @click="applyArmyModal = false">关闭</el-button>
        </span>
        </template>
    </el-dialog>

</div>
</template>
<script>
import { defineComponent, h } from 'vue'
import { ElMessageBox, ElMessage } from 'element-plus'
import { reactive } from "vue";

export default {
    data(){
        return{
            armyList:[],
            shipList:[],
            paymentInfo:{
                id:null,
                name:null,
                endTime:null,
                lossStartTime:null,
                lossEndTime:null,
                limitArea:null,
                limitConstellation:null,
                limitGalaxy:null
            },
            hasOutOfDate:true,
            uploadUrl:'/api/ocr/detectLossPic',
            detectResultList:[],
            loadingList:reactive({}),

            detailModal:false,
            modifyModal:false,
            lossInfo:{
                index:null,
                reportId:null,
                reportTime:null,
                armyShortName:'',
                gameId:'',
                shipName:'',
                area:'',
                constellation:'',
                galaxy:'',
                money:'',
                kmShip:'',
                highATKShip:''
            },
            imgSrc:'',
            imgModal:false,

            applyArmyModal:false,
            applyArmyShortName:null
        }
    },
    created(){
        this.paymentInfo.id = this.$route.query.pid;
        this.getAllArmy();
        this.getAllShip();
    },
    mounted(){
        if(this.paymentInfo.id!=null){
            this.getPaymentInfo();
        }
    },
    methods:{
        getAllArmy(){
            this.$request.get("/army/getAllArmy").then(res =>{
                console.log(res.obj);
                this.armyList = res.obj;
            })
        },

        getAllShip(){
            this.$request.get("/ship/getAllShip").then(res =>{
                console.log(res.obj);
                this.shipList = res.obj;
            })
        },


        openModifyModal(value,index){
            console.log(value);
            this.lossInfo.index = index;
            this.lossInfo.reportId = value.reportId;
            this.lossInfo.reportTime = value.reportTime==null?null:new Date(value.reportTime);
            this.lossInfo.armyShortName = value.armyShortName;
            this.lossInfo.gameId = value.gameId;
            this.lossInfo.shipName = value.shipName;
            this.lossInfo.area = value.area;
            this.lossInfo.constellation = value.constellation;
            this.lossInfo.galaxy = value.galaxy;
            this.lossInfo.money = Number(value.money);
            this.lossInfo.kmShip = value.kmShip;
            this.lossInfo.highATKShip = value.highATKShip;
            this.modifyModal = true;
        },

        modifyData(){
            this.detectResultList[this.lossInfo.index].reportTime = this.lossInfo.reportTime.format("yyyy-MM-dd hh:mm:ss");
            this.detectResultList[this.lossInfo.index].armyShortName = this.lossInfo.armyShortName;
            this.detectResultList[this.lossInfo.index].gameId = this.lossInfo.gameId;
            this.detectResultList[this.lossInfo.index].shipName = this.lossInfo.shipName;
            this.detectResultList[this.lossInfo.index].area = this.lossInfo.area;
            this.detectResultList[this.lossInfo.index].constellation = this.lossInfo.constellation;
            this.detectResultList[this.lossInfo.index].galaxy = this.lossInfo.galaxy;
            this.detectResultList[this.lossInfo.index].money = this.lossInfo.money;
            this.detectResultList[this.lossInfo.index].kmShip = this.lossInfo.kmShip;
            this.detectResultList[this.lossInfo.index].highATKShip = this.lossInfo.highATKShip;
            this.detectResultList[this.lossInfo.index].isModify = true;
            this.modifyModal = false;
        },

        openImgModal(imgSrc){
            this.imgSrc = imgSrc;
            this.imgModal = true;
        },
        getPaymentInfo(){
            this.$request.get("/payment/getPaymentInfo",{
                pid:this.paymentInfo.id
            }).then(res=>{
                this.paymentInfo.name = res.obj.name;
                this.paymentInfo.endTime = res.obj.endTime;
                this.paymentInfo.lossStartTime = res.obj.lossStartTime;
                this.paymentInfo.lossEndTime = res.obj.lossEndTime;
                this.paymentInfo.limitArea = res.obj.limitArea==null?null:JSON.parse(res.obj.limitArea);
                this.paymentInfo.limitConstellation = res.obj.limitConstellation==null?null:JSON.parse(res.obj.limitConstellation);
                this.paymentInfo.limitGalaxy = res.obj.limitGalaxy==null?null:JSON.parse(res.obj.limitGalaxy);

                this.hasOutOfDate = new Date().getTime()>new Date(this.paymentInfo.endTime).getTime();

                console.log(this.paymentInfo);

                this.detailModal = true;
            })
        },
        
        beforeUpload(file){
            let isJPG = file.type === 'image/jpeg';
            let isPNG = file.type === 'image/png';

            if(!isJPG&&!isPNG){
                ElMessage.error('只可以上传JPG或PNG图像');
            }
            this.loadingList[file.name] = 0;
            return isJPG || isPNG;
        },

        uploadProgress(event, file, fileList){
            this.loadingList[file.name] = Number((event.percent).toFixed(1));
            console.log(event, file, fileList);
        },

        handleSuccess(response, file, fileList){
            console.log(response);
            delete this.loadingList[file.name];
            let num = 0;
            let errorList = [];
            if(response.obj.dataType&&response.obj.dataType=="single"){
                let verifyResult = this.verifyDetect(response.obj);
                if(verifyResult==null){
                    response.obj.info = undefined;
                    response.obj.isModify = false;
                    response.obj.paymentId = this.paymentInfo.id;
                    this.detectResultList.push(response.obj);
                    num++;
                }else{
                    errorList.push("【"+response.obj.shipName+"】"+verifyResult);
                }
            }else if(response.obj.dataType&&response.obj.dataType=="multiple"){
                console.log(response.obj.list);
                for(let item of response.obj.list){
                    let verifyResult = this.verifyDetect(item);
                    if(verifyResult==null){
                        let detectResult = {
                            reportTime:item.reportTime,
                            shipName:item.shipName,
                            area:item.area,
                            constellation:item.constellation,
                            galaxy:item.galaxy,
                            armyShortName:item.armyShortName,
                            gameId:item.gameId,
                            money:item.money,
                            kmShip:item.kmShip,
                            kmArmyShortName:item.kmArmyShortName,
                            kmGameId:item.kmGameId,
                            highATKShip:item.highATKShip,
                            info:undefined,
                            isModify:false,
                            paymentId:this.paymentInfo.id,
                            img:response.obj.img
                        }

                        this.detectResultList.push(detectResult);
                        num++;
                    }else{
                        errorList.push("【"+item.shipName+"】"+verifyResult);
                    }
                }
            }
            if(errorList.length==0){
                ElMessage({
                    message: '识别'+num+'条记录',
                    type: 'success',
                })
            }else{
                let errorInfo = '';
                for(let item of errorList){
                    errorInfo+=item+','
                }
                errorInfo = errorInfo.substring(0,errorInfo.length-1);
                ElMessage.error('识别'+num+'条记录,'+errorInfo);
            }

            
        },

        verifyDetect(value){
            // if(isEmpty(value.gameId)&&isEmpty(value.armyShortName)){
            //     ElMessage.error('识别结果缺失身份信息，请换一张图试试');
            //     return;
            // }
            // if(isEmpty(value.shipName)){
            //     ElMessage.error('识别结果缺失舰船名，请换一张图试试');
            //     return;
            // }

            if(!isEmpty(this.paymentInfo.lossStartTime)){
                if(!isEmpty(value.reportTime)){
                    let lossStartTime = new Date(this.paymentInfo.lossStartTime).getTime();

                    let reportTime = new Date(value.reportTime).getTime();

                    if(reportTime<lossStartTime){
                        // ElMessage.error('时间不合规');
                        // return false;
                        return '时间不合规';
                    }

                }else{
                    // ElMessage.error('识别结果缺失时间，请换一张图试试');
                    // return false;
                    return '识别结果缺失时间';
                }
            }

            if(!isEmpty(this.paymentInfo.lossEndTime)){
                if(!isEmpty(value.reportTime)){
                    let lossEndTime = new Date(this.paymentInfo.lossEndTime).getTime();

                    let reportTime = new Date(value.reportTime).getTime();

                    if(reportTime>lossEndTime){
                        // ElMessage.error('时间不合规');
                        // return false;
                        return '时间不合规';
                    }
                }else{
                    // ElMessage.error('识别结果缺失时间，请换一张图试试');
                    // return false;
                    return '识别结果缺失时间，请换一张图试试';
                }
            }

            // let isInclude = false;
            // if(this.paymentInfo.limitArea!=null||this.paymentInfo.limitConstellation!=null||this.paymentInfo.limitGalaxy!=null){
                
            //     if(this.paymentInfo.limitArea!=null&&!isEmpty(value.area)){
            //         if(this.paymentInfo.limitArea.indexOf(value.area)!=-1){
            //             isInclude = true;
            //         }
            //     }
            //     if(this.paymentInfo.limitConstellation!=null&&!isEmpty(value.constellation)){
            //         if(this.paymentInfo.limitConstellation.indexOf(value.constellation)!=-1){
            //             isInclude = true;
            //         }
            //     }
            //     if(this.paymentInfo.limitGalaxy!=null&&!isEmpty(value.galaxy)){
            //         if(this.paymentInfo.limitGalaxy.indexOf(value.galaxy)!=-1){
            //             isInclude = true;
            //         }
            //     }
            // }else{
            //     isInclude = true;
            // }

            // if(!isInclude){
            //     return "地点不合规";
            // }

            return null;
        },

        removeResult(index){
            this.detectResultList.splice(index,1);
        },

        submit(){
            this.$request.post("/loss/addLoss",this.detectResultList).then(res=>{
                let count = 0;
                for(let key in res.obj){
                    count++;
                }
                if(count==0){
                    ElMessage({
                        message: '上报成功',
                        type: 'success',
                    })
                    this.detectResultList = [];
                }else{
                    ElMessage({
                        message: '部分上报失败的内容已返回',
                        type: 'warning',
                    })
                    this.detectResultList = res.obj;
                }
                
            });
        },

        applyArmy(){
            for(let item of this.detectResultList){
                if(item.armyShortName != this.applyArmyShortName){
                    item.armyShortName = this.applyArmyShortName;
                    item.isModify = true;
                }
            }
            this.applyArmyModal = false;
        },

        thousandBitSeparator(str){ 
            str = String(str);
            if (str.indexOf('.')>=0) {
                var postfix = str.substring(str.indexOf('.'));
                str = str.substring(0,str.indexOf('.'));
            }else{
                var postfix = '';
            };
            // console.log(postfix);
            // .99
            // console.log(str);
            // 9999999999999
            var iNum = str.length % 3; 
            var prev = ''; 
            var iNow = 0; 
            var temp = ''; 
            var arr = []; 
            if (iNum != 0){ 
                prev = str.substring(0, iNum); 
                arr.push(prev); 
            } 
            str = str.substring(iNum); 
            for (var i = 0; i < str.length; i++){ 
                iNow++; 
                temp += str[i]; 
                if (iNow == 3 && temp){ 
                arr.push(temp); 
                temp = ''; 
                iNow = 0; 
                } 
            } 
            // console.log(arr);
            // ["9", "999", "999", "999", "999"]
            return arr.join(',') + postfix; 
        }
    }

}
/**
 * 判断数据是否为空
 * @param value 需要验证的数据
 * @returns {boolean}
 */
function isEmpty(value) {
  if (
    value === undefined ||
    value === null ||
    value === "" ||
    value.toString().trim().length === 0
  ) {
    return true;
  } else {
    return false;
  }
}
</script>
<style lang="less">
.reportPayment{
    height:100%;
    width:100%;
    text-align: center;

    .payment-box{
        text-align: left;

        .payment-item{
            line-height:20px;
        }
    }

    .report-box{
        margin-top:50px;
        text-align: left;


        .report-item{
            height:20px;
            line-height:20px;
        }
    }

    .modify-box{

        .modify-item{
            height:45px;
            line-height:45px;
        }
    }


    .header{
        height:60px;
        line-height: 60px;
        width:100%;
        background-color: rgb(64, 134, 226);
        color:white;
        position: relative;

        .title{
            margin:0 auto;
        }

        .header-right{
            position:absolute;
            right:0;
            top:0;
        }

        .header-right:hover{
            cursor: pointer;
        }

    }

    .list{
        height: calc(100% - 30px);
        overflow-y: scroll;
        background-color: rgb(236,240,245);
        

        .list-item{
            height:240px;
            width:100%;

            .box-card{
                position:relative;

                .box-remove{
                    position:absolute;
                    right:15px;
                    top:10px;
                    color:red;
                }

                .box-remove:hover{
                    cursor: pointer;
                }

                .box-img{
                    position: absolute;
                    right:20px;
                    bottom:20px;

                    img{
                        height:90px;
                        width:120px;
                    }
                }

                .box-info{
                    position: absolute;
                    right:20px;
                    bottom:20px;
                    color:tomato;

                }

            }
        }

        .sumbit-button{
            position:fixed;
            color:white;
            bottom:20px;
            right:20px;
            height:80px;
            line-height:80px;
            width:80px;
            border-radius: 40px;
            background-color: rgb(64,134,226);
        }

        .sumbit-button:hover{
            cursor: pointer;
        }
    }
}
</style>